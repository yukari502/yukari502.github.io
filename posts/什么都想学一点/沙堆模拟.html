<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D æ²™å †æ¨¡å‹ - å¯å˜é˜ˆå€¼ç‰ˆ</title>
    <meta name="build-hash" content="96f8b838d47890c28615945202a7715e">
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0a0a15;
            color: #eee;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
        }

        /* --- å³ä¸Šè§’æŠ˜å ç»Ÿè®¡é¢æ¿ --- */
        #stats-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 280px;
            background: rgba(25, 25, 35, 0.95);
            border: 1px solid #445;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            z-index: 100;
            transition: height 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #stats-header {
            padding: 12px 15px;
            cursor: pointer;
            background: rgba(50, 50, 70, 0.5);
            border-bottom: 1px solid #445;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #4fc3f7;
            letter-spacing: 1px;
        }

        #stats-header:hover {
            background: rgba(70, 70, 90, 0.6);
        }

        #stats-content {
            padding: 15px;
            display: block;
        }

        #stats-panel.collapsed #stats-content {
            display: none;
        }

        #stats-panel.collapsed #stats-header {
            border-bottom: none;
            border-radius: 8px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
            color: #ccc;
        }

        .metric-val {
            font-family: 'Consolas', monospace;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
        }

        .highlight-blue {
            color: #4fc3f7;
        }

        .highlight-red {
            color: #ff8a80;
        }

        /* --- åº•éƒ¨æ§åˆ¶æ  --- */
        #bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(20, 20, 30, 0.95);
            border-top: 1px solid #445;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 100;
            padding: 0 20px;
            box-sizing: border-box;
        }

        button {
            background: #334;
            color: #ddd;
            border: 1px solid #556;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        button:hover {
            background: #445;
            border-color: #4fc3f7;
            color: #4fc3f7;
        }

        button.active {
            background: #0277bd;
            border-color: #039be5;
            color: white;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #223;
            padding: 5px 12px;
            border-radius: 30px;
            border: 1px solid #445;
        }

        .label-text {
            font-size: 12px;
            color: #aaa;
            white-space: nowrap;
        }

        /* æ»‘åŠ¨æ¡ */
        input[type=range] {
            width: 100px;
            cursor: pointer;
            accent-color: #4fc3f7;
            height: 4px;
        }

        /* æ•°å­—è¾“å…¥æ¡† */
        input[type=number] {
            width: 40px;
            background: #111;
            border: 1px solid #555;
            color: #4fc3f7;
            border-radius: 4px;
            padding: 2px 5px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            background: #1a1a25;
            border-radius: 4px;
            border: 1px solid #334;
            padding: 5px;
            position: relative;
        }

        .chart-label {
            position: absolute;
            font-size: 10px;
            color: #667;
        }
    </style>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.150.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/"
        }
      }
    </script>
    <meta name="build-hash" content="96f8b838d47890c28615945202a7715e">
</head>

<body>

    <div id="stats-panel">
        <div id="stats-header" onclick="toggleStats()">
            <span>ğŸ“Š å¹‚å¾‹åˆ†å¸ƒéªŒè¯</span>
            <span id="toggle-icon">â–¼</span>
        </div>
        <div id="stats-content">
            <div class="metric-row"><span>æŠ•æ”¾æ€»é‡ (Grains):</span> <span class="metric-val" id="disp-grains">0</span></div>
            <div class="metric-row"><span>æœ€å¤§é›ªå´© (Max S):</span> <span class="metric-val highlight-red"
                    id="disp-max">0</span></div>
            <div class="metric-row"><span>å½“å‰é›ªå´© (Current S):</span> <span class="metric-val highlight-blue"
                    id="disp-current-s">0</span></div>
            <div class="metric-row"><span>å½“å‰é˜ˆå€¼ (K):</span> <span class="metric-val" id="disp-k"
                    style="color:#ffff00">4</span></div>

            <div style="margin-top: 15px;">
                <div style="font-size: 11px; color: #aaa; margin-bottom: 5px;">Log-Log Plot (åŒå¯¹æ•°åæ ‡)</div>
                <div class="chart-container">
                    <canvas id="chart-canvas" width="240" height="100"
                        style="display: block; cursor: crosshair;"></canvas>
                    <div class="chart-label" style="bottom: 2px; right: 5px;">Log(Size) â†’</div>
                    <div class="chart-label"
                        style="top: 5px; left: 2px; transform: rotate(-90deg); transform-origin: left top;">Log(Freq) â†’
                    </div>
                </div>
            </div>

            <div
                style="margin-top:10px; font-size:11px; color:#778; border-top:1px solid #445; padding-top:5px; text-align: center;">
                å·¦é”®æ—‹è½¬ | å³é”®å¹³ç§» | æ»šè½®ç¼©æ”¾
            </div>
        </div>
    </div>

    <div id="bottom-bar">
        <button id="btn-toggle">æš‚åœ</button>
        <button id="btn-reset">é‡ç½®</button>

        <div class="control-group">
            <span class="label-text">é€Ÿåº¦</span>
            <input type="range" id="speed-slider" min="1" max="200" value="50" step="1">
            <span class="val-text" id="speed-val"
                style="font-family:'Consolas'; color:#4fc3f7; font-size:12px; width:25px;">50</span>
        </div>

        <div class="control-group" style="border-color: #665; background: #2a2a35;">
            <span class="label-text" style="color: #ffff8d;">é˜ˆå€¼(K)</span>
            <input type="number" id="k-input" min="2" max="8" value="4">
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const CONFIG = {
            gridSize: 60, cubeSize: 0.8, spacing: 1.0,
            bgColor: 0x111122
        };

        const state = {
            grid: new Int8Array(CONFIG.gridSize * CONFIG.gridSize).fill(0),
            queue: [], totalGrains: 0, maxAvalancheSize: 0, currentAvalancheSize: 0,
            frequencyMap: new Map(),
            isRunning: true, speed: 50,
            // æ–°å¢ï¼šåŠ¨æ€é˜ˆå€¼
            criticalVal: 4
        };

        // --- Three.js Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(CONFIG.bgColor);
        scene.fog = new THREE.Fog(CONFIG.bgColor, 30, 120);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(CONFIG.gridSize * 1.3, CONFIG.gridSize * 1.1, CONFIG.gridSize * 1.3);
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        document.body.appendChild(renderer.domElement);

        // --- å…‰ç…§ (é«˜èƒ½è§åº¦) ---
        const ambientLight = new THREE.AmbientLight(0xccccff, 3.5);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 4.0);
        dirLight.position.set(80, 120, 60);
        scene.add(dirLight);
        const fillLight = new THREE.DirectionalLight(0xaaaaff, 1.5);
        fillLight.position.set(-50, 50, -50);
        scene.add(fillLight);

        const controls = new OrbitControls(camera, renderer.domElement); controls.target.set(0, 0, 0); controls.enableDamping = true; controls.dampingFactor = 0.05;
        controls.autoRotate = true; controls.autoRotateSpeed = 0.5;

        const totalInstances = CONFIG.gridSize * CONFIG.gridSize;
        // æè´¨ï¼šshininess æ”¹å› 30ï¼Œä¿æŒæŸ”å’Œå…‰æ³½
        const material = new THREE.MeshPhongMaterial({ color: 0xffffff, flatShading: true, shininess: 30, specular: 0x444444 });
        const mesh = new THREE.InstancedMesh(new THREE.BoxGeometry(CONFIG.cubeSize, 1, CONFIG.cubeSize), material, totalInstances);
        scene.add(mesh);
        const dummy = new THREE.Object3D();
        const tempColor = new THREE.Color();
        scene.add(new THREE.GridHelper(CONFIG.gridSize * CONFIG.spacing, CONFIG.gridSize, 0x666688, 0x333344));

        // --- é¢œè‰²ç”Ÿæˆå‡½æ•° (åŠ¨æ€é€‚é… K å€¼) ---
        function getColorForVal(val, maxVal) {
            if (val === 0) return 0x111122; // åº•è‰²
            if (val >= maxVal) return 0xffffff; // å´©å¡Œè‰²

            // åœ¨è“è‰²åŒºé—´å†…æ ¹æ®é«˜åº¦æ’å€¼
            // ä½¿ç”¨ HSL: è‰²ç›¸å›ºå®šä¸ºè“è‰²(0.6), äº®åº¦ä»æ·±(0.2)åˆ°äº®(0.6)
            const ratio = val / (maxVal - 1); // 0.0 ~ 1.0
            const lightness = 0.2 + (ratio * 0.4);
            tempColor.setHSL(0.6, 0.8, lightness);
            return tempColor;
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function updateVisuals() {
            const offset = (CONFIG.gridSize * CONFIG.spacing) / 2 - (CONFIG.spacing / 2);
            const K = state.criticalVal;

            for (let i = 0; i < totalInstances; i++) {
                const val = state.grid[i];
                const x = (i % CONFIG.gridSize) * CONFIG.spacing - offset;
                const z = Math.floor(i / CONFIG.gridSize) * CONFIG.spacing - offset;

                // åŠ¨æ€é«˜åº¦ï¼šæ ¹æ®å½“å‰çš„ K å€¼å½’ä¸€åŒ–é«˜åº¦ï¼Œä¿è¯ K=8 æ—¶ä¸ä¼šå†²å‡ºå±å¹•
                // åŸºç¡€é«˜åº¦ + (å½“å‰å€¼ / é˜ˆå€¼) * æ¯”ä¾‹ç³»æ•°
                let visualHeight = val === 0 ? 0.05 : (val / K) * 3.0;

                // å´©å¡Œæ—¶ç¨å¾®æ‹”é«˜ä¸€ç‚¹
                if (val >= K) visualHeight = 3.5;

                dummy.position.set(x, visualHeight / 2, z);
                dummy.scale.set(1, visualHeight, 1);
                dummy.updateMatrix();
                mesh.setMatrixAt(i, dummy.matrix);

                // åŠ¨æ€é¢œè‰²
                if (val === 0) tempColor.setHex(0x111122);
                else if (val >= K) tempColor.setHex(0xffffff);
                else {
                    // ç®€å•çš„æ’å€¼é¢œè‰²ï¼šæ·±è“ -> äº®è“
                    const t = (val - 1) / Math.max(1, K - 1); // 0~1
                    tempColor.setHSL(0.6, 0.9, 0.2 + t * 0.4);
                }

                mesh.setColorAt(i, tempColor);
            }
            mesh.instanceMatrix.needsUpdate = true; mesh.instanceColor.needsUpdate = true;
        }

        function recordAvalanche(size) {
            if (size <= 0) return;
            if (size > state.maxAvalancheSize) state.maxAvalancheSize = size;
            const count = state.frequencyMap.get(size) || 0;
            state.frequencyMap.set(size, count + 1);
            drawChart();
        }

        function simulationStep() {
            if (!state.isRunning) return;
            let ops = state.speed;
            const total = CONFIG.gridSize * CONFIG.gridSize;
            const K = state.criticalVal; // è·å–å½“å‰é˜ˆå€¼

            while (ops > 0) {
                if (state.queue.length > 0) {
                    const idx = state.queue.shift();
                    // æ£€æŸ¥åŠ¨æ€é˜ˆå€¼
                    if (state.grid[idx] < K) { ops--; continue; }

                    // å´©å¡Œé€»è¾‘ï¼šå‡å»é˜ˆå€¼
                    state.grid[idx] -= K;
                    state.currentAvalancheSize++;

                    const neighbors = [idx - 1, idx + 1, idx - CONFIG.gridSize, idx + CONFIG.gridSize];
                    for (let nIdx of neighbors) {
                        if (nIdx >= 0 && nIdx < total && Math.abs((nIdx % CONFIG.gridSize) - (idx % CONFIG.gridSize)) <= 1) {
                            state.grid[nIdx]++;
                            // åŠ¨æ€é˜ˆå€¼åˆ¤æ–­
                            if (state.grid[nIdx] >= K) state.queue.push(nIdx);
                        }
                    }
                    ops--;
                } else {
                    if (state.currentAvalancheSize > 0) {
                        recordAvalanche(state.currentAvalancheSize);
                        state.currentAvalancheSize = 0;
                    }
                    const idx = Math.floor(Math.random() * total);
                    state.grid[idx]++; state.totalGrains++;
                    // åŠ¨æ€é˜ˆå€¼åˆ¤æ–­
                    if (state.grid[idx] >= K) state.queue.push(idx);
                    ops--;
                }
            }
        }

        // --- Log-Log å›¾è¡¨ç»˜åˆ¶ ---
        const chartCanvas = document.getElementById('chart-canvas');
        const chartCtx = chartCanvas.getContext('2d');

        function drawChart() {
            const w = chartCanvas.width; const h = chartCanvas.height;
            chartCtx.clearRect(0, 0, w, h);
            const data = Array.from(state.frequencyMap.entries());
            if (data.length < 2) return;
            let maxS = 0, maxF = 0;
            data.forEach(([s, f]) => { maxS = Math.max(maxS, s); maxF = Math.max(maxF, f); });
            const logMaxS = Math.log10(Math.max(maxS, 10));
            const logMaxF = Math.log10(Math.max(maxF, 10));
            const padding = 10;
            const plotW = w - padding * 2;
            const plotH = h - padding * 2;
            chartCtx.fillStyle = '#4fc3f7';
            data.forEach(([s, f]) => {
                const x = padding + (Math.log10(s) / logMaxS) * plotW;
                const y = h - padding - (Math.log10(f) / logMaxF) * plotH;
                chartCtx.beginPath(); chartCtx.arc(x, y, 2, 0, Math.PI * 2); chartCtx.fill();
            });
        }

        // --- UI & Interaction ---
        window.toggleStats = function () {
            const panel = document.getElementById('stats-panel');
            document.getElementById('toggle-icon').innerText = panel.classList.toggle('collapsed') ? 'â—€' : 'â–¼';
        }
        document.getElementById('btn-toggle').onclick = function () {
            state.isRunning = !state.isRunning; this.innerText = state.isRunning ? "æš‚åœ" : "ç»§ç»­"; this.classList.toggle('active');
            controls.autoRotate = !state.isRunning;
        };
        document.getElementById('btn-reset').onclick = function () {
            state.grid.fill(0); state.queue = []; state.totalGrains = 0;
            state.maxAvalancheSize = 0; state.currentAvalancheSize = 0;
            state.frequencyMap.clear();
            updateVisuals(); updateUI(0, true); drawChart();
        };

        const speedSlider = document.getElementById('speed-slider');
        speedSlider.oninput = function () {
            state.speed = parseInt(this.value);
            document.getElementById('speed-val').innerText = state.speed;
        };

        // é˜ˆå€¼æ§åˆ¶é€»è¾‘
        const kInput = document.getElementById('k-input');
        kInput.onchange = function () {
            let val = parseInt(this.value);
            if (val < 2) val = 2;
            if (val > 8) val = 8; // é™åˆ¶æœ€å¤§ä¸º8ï¼Œé˜²æ­¢é¢œè‰²æº¢å‡º
            this.value = val;
            state.criticalVal = val;
            document.getElementById('disp-k').innerText = val;

            // æ³¨æ„ï¼šæ”¹å˜Kå€¼å¯èƒ½å¯¼è‡´ç³»ç»Ÿç¬é—´ä¸ç¨³å®šï¼ˆå¦‚æœKå˜å°ï¼‰æˆ–å˜å¾—éå¸¸ç¨³å®šï¼ˆå¦‚æœKå˜å¤§ï¼‰
            // ä¸‹ä¸€å¸§ simulationStep ä¼šè‡ªåŠ¨å¤„ç†æ–°çš„ K å€¼é€»è¾‘
            // ä¸ºäº†è§†è§‰ä¸€è‡´æ€§ï¼Œç«‹å³åˆ·æ–°ä¸€æ¬¡
            updateVisuals();
        };

        let lastUiUpdate = 0;
        function updateUI(timestamp, force = false) {
            if (force || timestamp - lastUiUpdate > 150) {
                document.getElementById('disp-grains').innerText = state.totalGrains;
                document.getElementById('disp-max').innerText = state.maxAvalancheSize;
                document.getElementById('disp-current-s').innerText = state.currentAvalancheSize;
                lastUiUpdate = timestamp;
            }
        }

        function animate(timestamp) {
            requestAnimationFrame(animate);
            simulationStep();
            updateVisuals();
            updateUI(timestamp);
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
        });
        renderer.domElement.addEventListener('mousedown', () => { controls.autoRotate = false; });

        animate(0); drawChart();
    </script>
</body>

</html>